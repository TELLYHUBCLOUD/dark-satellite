<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>O Level Exam Portal - Admin</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <nav class="navbar">
        <div class="container navbar-content">
            <div class="navbar-brand">üéì Admin Portal</div>
            <ul class="navbar-nav">
                <li><a href="/" class="nav-link">Home</a></li>
                <li><a href="/admin/logout" class="nav-link">Logout</a></li>
            </ul>
        </div>
    </nav>

    <section class="section">
        <div class="container">
            <h2 class="text-center" style="margin-bottom: 2rem;">Admin Dashboard</h2>

            <!-- Stats Overview -->
            <div class="dashboard-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Students</div>
                    <div class="stat-value">{{ stats.total_students }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Exams Completed</div>
                    <div class="stat-value">{{ stats.exams_completed }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Questions</div>
                    <div class="stat-value">{{ stats.total_questions }}</div>
                </div>
            </div>

            <!-- Student Management -->
            <div class="glass-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3>Registered Students</h3>
                    <button class="btn btn-outline" style="border-color: var(--error); color: var(--error);"
                        onclick="deleteAllStudents()">
                        Delete ALL Registrations
                    </button>
                </div>
                <div id="studentsContainer">
                    <p class="text-center" style="color: var(--text-muted);">Loading students...</p>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="glass-card" style="margin-top: 2rem;">
                <h3 style="margin-bottom: 1.5rem;">Quick Actions</h3>
                <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <a href="/admin/reset_exam" class="btn btn-secondary" style="text-align: center; padding: 2rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üîÑ</div>
                        <div>Reset Student Exam</div>
                    </a>
                    <a href="/admin/add_question" class="btn btn-primary" style="text-align: center; padding: 2rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚ûï</div>
                        <div>Add / Upload Questions</div>
                    </a>
                </div>
            </div>

            <!-- Question Bank Summary -->
            <div class="glass-card" style="margin-top: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3>Question Bank</h3>
                    <div style="display: flex; gap: 1rem;">
                        <button id="deleteSelectedBtn" class="btn btn-danger" style="display: none;"
                            onclick="deleteSelectedQuestions()">
                            Delete Selected (<span id="selectedCount">0</span>)
                        </button>
                        <button class="btn btn-outline" style="border-color: var(--error); color: var(--error);"
                            onclick="deleteAllQuestions()">
                            Delete ALL Questions
                        </button>
                    </div>
                </div>
                <div id="questionsContainer">
                    <p class="text-center" style="color: var(--text-muted);">Loading questions...</p>
                </div>
            </div>
        </div>
    </section>

    <script>
        let allQuestions = [];
        let selectedQuestions = new Set();

        // Load all students
        async function loadStudents() {
            try {
                const response = await fetch('/api/admin/students');
                const data = await response.json();

                if (data.success) {
                    const container = document.getElementById('studentsContainer');

                    if (data.students.length === 0) {
                        container.innerHTML = '<p class="text-center" style="color: var(--text-muted); padding: 2rem;">No students registered yet</p>';
                        return;
                    }

                    container.innerHTML = `
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Roll Number</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>DOB</th>
                                        <th>Password (Hash)</th>
                                        <th>Exam Status</th>
                                        <th>Registered At</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.students.map(student => `
                                        <tr>
                                            <td>${student.roll_number}</td>
                                            <td>${student.name}</td>
                                            <td>${student.email}</td>
                                            <td>${student.phone}</td>
                                            <td>${student.dob}</td>
                                            <td title="${student.password}">${student.password}</td>
                                            <td>
                                                ${student.completed_subjects && student.completed_subjects.length > 0
                            ? student.completed_subjects.map(subject =>
                                `<span style="display: inline-block; background: rgba(72, 187, 120, 0.2); color: #48bb78; padding: 2px 8px; border-radius: 12px; font-size: 0.85em; margin-right: 4px; margin-bottom: 4px;">${subject}</span>`
                            ).join('')
                            : '<span style="color: var(--warning);">‚è≥ Pending</span>'}
                                            </td>
                                            <td>${student.registered_at}</td>
                                            <td>
                                                <div style="display: flex; gap: 5px;">
                                                    ${student.completed_subjects && student.completed_subjects.length > 0
                            ? `<a href="/result/${student.roll_number}" target="_blank" class="btn btn-outline" style="padding: 0.5rem 1rem; font-size: 0.85rem;" title="View Result">üìÑ</a>`
                            : ''}
                                                    <button class="btn btn-danger" style="padding: 0.5rem 1rem; font-size: 0.85rem;" onclick="deleteStudent('${student.roll_number}')" title="Delete Student">üóëÔ∏è</button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load students');
            }
        }

        // Load all questions
        async function loadQuestions() {
            try {
                const response = await fetch('/api/admin/questions');
                const data = await response.json();

                if (data.success) {
                    allQuestions = data.questions;
                    renderQuestions();
                }
            } catch (error) {
                console.error('Failed to load questions');
            }
        }

        function renderQuestions() {
            const container = document.getElementById('questionsContainer');
            selectedQuestions.clear();
            updateBulkActionUI();

            if (allQuestions.length === 0) {
                container.innerHTML = '<p class="text-center" style="color: var(--text-muted); padding: 2rem;">No questions found.</p>';
                return;
            }

            container.innerHTML = `
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                </th>
                                <th>Question</th>
                                <th>Subject</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allQuestions.map(q => `
                                <tr>
                                    <td>
                                        <input type="checkbox" class="question-checkbox" value="${q.id}" onchange="toggleSelection('${q.id}')">
                                    </td>
                                    <td>${q.question}</td>
                                    <td>${q.subject}</td>
                                    <td>
                                        <button class="btn btn-danger" onclick="deleteQuestion('${q.id}')">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.question-checkbox');

            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
                if (selectAll.checked) {
                    selectedQuestions.add(cb.value);
                } else {
                    selectedQuestions.delete(cb.value);
                }
            });
            updateBulkActionUI();
        }

        function toggleSelection(id) {
            if (selectedQuestions.has(id)) {
                selectedQuestions.delete(id);
            } else {
                selectedQuestions.add(id);
            }

            // Update Select All checkbox state
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.question-checkbox');
            selectAll.checked = selectedQuestions.size === checkboxes.length && checkboxes.length > 0;

            updateBulkActionUI();
        }

        function updateBulkActionUI() {
            const btn = document.getElementById('deleteSelectedBtn');
            const countSpan = document.getElementById('selectedCount');

            if (selectedQuestions.size > 0) {
                btn.style.display = 'inline-block';
                countSpan.textContent = selectedQuestions.size;
            } else {
                btn.style.display = 'none';
            }
        }

        async function deleteSelectedQuestions() {
            if (!confirm(`Are you sure you want to delete ${selectedQuestions.size} questions?`)) {
                return;
            }

            try {
                const response = await fetch('/api/admin/questions/delete_bulk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids: Array.from(selectedQuestions) })
                });

                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    loadQuestions();
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                alert('Failed to delete selected questions.');
            }
        }

        async function deleteStudent(rollNumber) {
            if (!confirm(`Are you sure you want to delete student ${rollNumber}? This will also delete their exam results.`)) {
                return;
            }

            try {
                const response = await fetch('/api/admin/students/' + rollNumber, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert('Student deleted successfully');
                    loadStudents();
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                alert('Failed to delete student');
            }
        }

        async function deleteAllStudents() {
            if (!confirm('WARNING: This will delete ALL registered students. This action cannot be undone. Are you sure?')) {
                return;
            }

            if (!confirm('Double Check: Are you absolutely sure you want to delete ALL student data?')) {
                return;
            }

            try {
                const response = await fetch('/api/admin/students/all', {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    loadStudents();
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                alert('Failed to delete all students.');
            }
        }

        async function deleteAllQuestions() {
            if (!confirm('WARNING: This will delete ALL questions from the database. This action cannot be undone. Are you sure?')) {
                return;
            }

            if (!confirm('Double Check: Are you absolutely sure you want to delete EVERYTHING?')) {
                return;
            }

            try {
                const response = await fetch('/api/admin/questions/all', {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    loadQuestions();
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                alert('Failed to delete all questions.');
            }
        }

        // Delete a question
        async function deleteQuestion(questionId) {
            if (confirm('Are you sure you want to delete this question?')) {
                try {
                    const response = await fetch('/api/admin/questions/' + questionId, {
                        method: 'DELETE'
                    });

                    const data = await response.json();

                    if (data.success) {
                        alert('Question deleted successfully!');
                        loadQuestions();
                    } else {
                        alert('Error: ' + data.message);
                    }
                } catch (error) {
                    alert('Failed to delete question. Please try again.');
                }
            }
        }

        // Load data on page load
        window.addEventListener('load', () => {
            loadStudents();
            loadQuestions();
        });
    </script>
</body>

</html>